name: Arch-RDP

on:
  workflow_dispatch:

jobs:
  arch-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Tailscale on Host
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-arch-runner --ephemeral

      - name: Setup Arch Linux Container
        run: |
          docker run -d --name arch-box -p 3389:3389 archlinux:latest sleep infinity

      - name: Configure Arch (GUI & RDP)
        run: |
          docker exec --user root arch-box bash -c "
            pacman -Syu --noconfirm
            pacman -S --noconfirm xfce4 xfce4-goodies base-devel git sudo
            
            # Create user and permit sudo
            useradd -m -G wheel -s /bin/bash archuser
            echo 'archuser:ArchPassword123' | chpasswd
            echo 'archuser ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

            # Build xrdp and xorgxrdp from AUR
            sudo -u archuser bash -c '
              cd ~
              git clone https://aur.archlinux.org/xrdp.git
              cd xrdp && makepkg -si --noconfirm
              cd ~
              git clone https://aur.archlinux.org/xorgxrdp.git
              cd xorgxrdp && makepkg -si --noconfirm
            '
            
            # Start XFCE on login
            echo 'exec startxfce4' > /home/archuser/.xinitrc
            chown archuser:archuser /home/archuser/.xinitrc
            
            # Initialize and start RDP services
            xrdp-keygen xrdp /etc/xrdp/rsakeys.ini
            xrdp-sesman
            xrdp
          "

      - name: Maintain Connection
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=== ARCH RDP ACCESS ==="
          echo "Address:  $TS_IP"
          echo "Username: archuser"
          echo "Password: ArchPassword123"
          echo "========================"
          
          while true; do
            echo "[$(date)] Arch RDP Heartbeat..."
            sleep 300
          done
