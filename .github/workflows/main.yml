name: Ubuntu-AI-RDP

on:
  workflow_dispatch:

jobs:
  ai-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-ai-runner" --reset

      - name: Install Desktop & AI Environment
        run: |
          # 1. Update and install XFCE + XRDP
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
          # 2. Configure XRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          sudo service xrdp restart

          # 3. Install Python AI Tools (The stuff from your code)
          # We install system dependencies for OpenCV first (libgl1)
          sudo apt-get install -y python3-pip python3-dev build-essential libgl1
          
          # Install your specific libraries
          # opencv-python-headless is lighter/faster for servers, 
          # but use 'opencv-python' if you need cv2.imshow() windows
          pip3 install flask numpy scipy pymongo opencv-python python-dotenv openpyxl

      - name: Start AI Project Directory
        run: |
          mkdir -p ~/ai-project
          echo "print('Hello from your Ubuntu AI RDP!')" > ~/ai-project/main.py

      - name: Connection Info
        run: |
          TS_IP=$(tailscale ip -4)
          echo " "
          echo "=========================================="
          echo "UBUNTU AI RDP READY"
          echo "Address: $TS_IP"
          echo "User:    runner"
          echo "Pass:    (Resetting password now...)"
          echo "=========================================="
          
          # Set a password for the default 'runner' user
          echo "runner:AiPassword123!" | sudo chpasswd
          
          # Keep alive
          while true; do
            sleep 300
          done
