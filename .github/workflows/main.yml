name: Arch-RDP

on:
  workflow_dispatch:

jobs:
  arch-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Tailscale on Host
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # Removed --ephemeral (set this in your Key settings instead)
          # Changed --authkey to --auth-key to match your log's help text
          sudo tailscale up \
            --auth-key="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --hostname="gh-arch-runner" \
            --reset

      - name: Setup Arch Linux Container
        run: |
          docker run -d --name arch-box -p 3389:3389 archlinux:latest sleep infinity

      - name: Configure Arch (GUI & RDP)
        run: |
          docker exec --user root arch-box bash -c "
            pacman -Syu --noconfirm
            pacman -S --noconfirm xfce4 xfce4-goodies base-devel git sudo
            
            # Create user for AUR building
            useradd -m -G wheel -s /bin/bash archuser
            echo 'archuser:ArchPassword123' | chpasswd
            echo 'archuser ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

            # Build xrdp and xorgxrdp from AUR (This takes 5-8 mins)
            sudo -u archuser bash -c '
              cd ~
              git clone https://aur.archlinux.org/xrdp.git
              cd xrdp && makepkg -si --noconfirm
              cd ~
              git clone https://aur.archlinux.org/xorgxrdp.git
              cd xorgxrdp && makepkg -si --noconfirm
            '
            
            # Startup config
            echo 'exec startxfce4' > /home/archuser/.xinitrc
            chown archuser:archuser /home/archuser/.xinitrc
            
            # Start services
            xrdp-keygen xrdp /etc/xrdp/rsakeys.ini
            xrdp-sesman
            xrdp
          "

      - name: Maintain Connection
        run: |
          TS_IP=$(tailscale ip -4)
          echo " "
          echo "=========================================="
          echo "ARCH RDP ACCESS ESTABLISHED"
          echo "Address:  $TS_IP"
          echo "Username: archuser"
          echo "Password: ArchPassword123"
          echo "=========================================="
          echo " "
          
          while true; do
            echo "[$(date)] Arch RDP Active..."
            sleep 300
          done
