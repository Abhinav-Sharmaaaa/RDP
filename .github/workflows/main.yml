name: Ubuntu-AI-RDP

on:
  workflow_dispatch:

jobs:
  ai-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-ai-runner" --reset

      - name: Install Desktop & AI Environment
        run: |
          # Install Desktop and RDP
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp python3-pip python3-dev build-essential libgl1
          
          # Fix Connectivity (Firewall & IPv4)
          sudo ufw allow 3389/tcp
          sudo sed -i 's/port=3389/port=tcp:\/\/:3389/' /etc/xrdp/xrdp.ini
          sudo service xrdp restart

          # Configure Session
          echo "xfce4-session" > ~/.xsession
          
          # Install AI Libraries
          pip3 install flask numpy scipy pymongo opencv-python python-dotenv openpyxl

      - name: Create AI File
        run: |
          mkdir -p ~/ai-project
          echo "print('System Ready')" > ~/ai-project/main.py

      - name: Connection Info
        run: |
          TS_IP=$(tailscale ip -4)
          echo " "
          echo "=========================================="
          echo "UBUNTU RDP READY"
          echo "Address: $TS_IP"
          echo "User:    runner"
          echo "Pass:    1"
          echo "=========================================="
          
          # Set password to '1'
          echo "runner:1" | sudo chpasswd
          
          while true; do
            sleep 300
          done
