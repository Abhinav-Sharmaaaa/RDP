name: Arch-RDP

on:
  workflow_dispatch:

jobs:
  arch-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Tailscale on Host
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-arch-runner

      - name: Setup Arch Linux Container
        run: |
          # Pull and run Arch, mapping RDP port 3389
          docker run -d --name arch-box -p 3389:3389 archlinux:latest sleep infinity

      - name: Configure Arch (GUI & RDP)
        run: |
          docker exec arch-box bash -c "
            pacman -Syu --noconfirm
            pacman -S --noconfirm xfce4 xfce4-goodies xrdp base-devel git
            
            # Create user
            useradd -m -G wheel -s /bin/bash archuser
            echo 'archuser:ArchPassword123' | chpasswd
            
            # Configure xrdp to start XFCE
            echo 'exec startxfce4' > /home/archuser/.xinitrc
            chmod +x /home/archuser/.xinitrc
            
            # Start xrdp services
            /usr/bin/xrdp-keygen xrdp /etc/xrdp/rsakeys.ini
            /usr/bin/xrdp
            /usr/bin/xrdp-sesman
          "

      - name: Output Connection Info
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=== ARCH RDP ACCESS ==="
          echo "Address:  $TS_IP"
          echo "Username: archuser"
          echo "Password: ArchPassword123"
          echo "========================"
          
          # Keep-alive loop
          while true; do
            echo "[$(date)] Arch RDP Heartbeat..."
            sleep 300
          done
