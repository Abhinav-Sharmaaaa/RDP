name: Win-AI-MaxPerf

on:
  workflow_dispatch:

jobs:
  win-max-perf:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        shell: powershell
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          $output = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          Start-Process -FilePath $output -ArgumentList "/quiet", "/norestart" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --auth-key="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-win-perf" --reset --force-reauth

      - name: ðŸš€ MAX PERFORMANCE TWEAKS
        shell: powershell
        run: |
          Write-Host "Killing Bloatware..."
          
          # 1. Disable Windows Defender (Huge speedup for Python imports/install)
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableIOAVProtection $true
          
          # 2. Stop Resource-Hogging Services
          Stop-Service -Name "WSearch" -Force -ErrorAction SilentlyContinue  # Search Indexing
          Stop-Service -Name "wuauserv" -Force -ErrorAction SilentlyContinue # Windows Update
          Stop-Service -Name "SysMain" -Force -ErrorAction SilentlyContinue  # Superfetch
          
          # 3. Enable High Performance Power Plan
          powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # 4. RDP Optimization (Disable NLA + Allow Firewall)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # 5. Visual Performance (Strip UI effects)
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2

      - name: Install AI Stack
        shell: powershell
        run: |
          # Upgrade pip to latest
          python -m pip install --upgrade pip
          
          # Install your AI tools + performance libraries
          # 'mkl' helps NumPy run faster on Intel/AMD CPUs
          pip install numpy scipy pymongo opencv-python flask python-dotenv openpyxl pandas matplotlib jupyterlab mkl
          
          # Create Project Shortcut
          New-Item -ItemType Directory -Force -Path "C:\Users\runneradmin\Desktop\AI_Work"
          Set-Content -Path "C:\Users\runneradmin\Desktop\AI_Work\test_perf.py" -Value "import cv2`nimport numpy as np`nimport time`n`nprint('Measuring Matrix Performance...')`nstart = time.time()`na = np.random.rand(5000, 5000)`nb = np.random.rand(5000, 5000)`nc = np.dot(a, b)`nprint(f'Done in {time.time()-start:.2f}s')"

      - name: Set Password & Connect
        shell: powershell
        run: |
          # Password must be complex for Windows Server
          net user runneradmin "AiPerformance1!"
          
          $tsIp = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host " "
          Write-Host "=========================================="
          Write-Host "   WINDOWS AI PERFORMANCE MODE READY"
          Write-Host "------------------------------------------"
          Write-Host "   IP:       $tsIp"
          Write-Host "   User:     runneradmin"
          Write-Host "   Pass:     AiPerformance1!"
          Write-Host "=========================================="
          
          while ($true) { Start-Sleep -Seconds 300 }
